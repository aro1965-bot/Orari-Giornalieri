<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Orari Vigilanza Privata</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  body { 
    font-family: system-ui; 
    padding: 20px; 
    margin:0;
    background: #001F3F;
    color: #FFFFFF;
  }
  h2 { margin-bottom: 10px; display:flex; align-items:center; font-size:24px; color: #FFD700; }
  h2 span { margin-right: 8px; }
  .month-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
  }
  .month-selector select {
    font-size: 16px;
    padding: 8px;
    border-radius: 8px;
    border: 2px solid #FFD700;
    background: #fff;
    color: #001F3F;
    cursor: pointer;
  }
  input, textarea, button { 
    font-size: 18px; 
    margin: 5px 0; 
    padding:8px; 
    width: 100%; 
    max-width: 400px; 
    border-radius: 8px; 
    border: 2px solid #FFD700;
    background: #fff;
    color: #001F3F;
  }
  input:focus, textarea:focus {
    outline: none;
    border-color: #FFC700;
    box-shadow: 0 0 5px rgba(255, 199, 0, 0.5);
  }
  ul { padding-left: 20px; }
  li { margin: 8px 0; font-size:16px; color: #FFD700; }
  .totali { 
    margin-top:20px; 
    font-weight:bold; 
    font-size:16px; 
    color: #FFD700;
    padding: 15px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 8px;
    border-left: 4px solid #FFD700;
  }
  .totali > div { margin: 5px 0; }
  .totali > span { color: #FFFFFF; font-weight: bold; }
  button { 
    cursor:pointer; 
    background:#FFD700;
    color:#001F3F;
    border: none; 
    border-radius:8px; 
    margin-top:8px;
    font-weight: bold;
    transition: background 0.3s ease;
  }
  button:hover { background:#FFC700; }
  button:active { transform: scale(0.98); }
  button.edit-btn {
    max-width: 30px; 
    padding: 4px; 
    margin-top: 3px;
    margin-right: 5px;
    background: #4CAF50;
  }
  button.edit-btn:hover { background: #45a049; }
  button.delete-btn {
    max-width: 30px; 
    padding: 4px; 
    margin-top: 3px;
    background: #f44336;
  }
  button.delete-btn:hover { background: #da190b; }
  label { 
    display:block; 
    margin-top:10px; 
    font-size:16px; 
    color: #FFFFFF;
    font-weight: 500;
  }
  textarea { 
    resize:none; 
    font-family: system-ui;
  }
  .error {
    color: #FF6B6B;
    font-size: 14px;
    margin-top: 5px;
    display: none;
  }
  .success {
    color: #51CF66;
    font-size: 14px;
    margin-top: 5px;
    text-align: center;
    display: none;
  }
  .info-text {
    font-size: 12px;
    color: #AAA;
    margin-top: 2px;
  }
  .editing-mode {
    background: rgba(76, 175, 80, 0.2);
    padding: 10px;
    border-radius: 8px;
    border: 2px solid #4CAF50;
    margin-bottom: 10px;
  }
  .editing-mode label {
    color: #4CAF50;
  }
  @media screen and (max-width:430px){
    input, textarea, button { font-size:16px; max-width:100%; }
    h2 { font-size:20px; }
    li { font-size:14px; }
    .totali { font-size:14px; }
    .month-selector { flex-direction: column; gap: 5px; }
    .month-selector select { width: 100%; }
  }
</style>
</head>
<body>

<h2><span>üëÆ‚Äç‚ôÇÔ∏è</span>I miei orari di lavoro</h2>

<div class="month-selector">
  <label for="monthSelector" style="margin: 0;">Mese:</label>
  <select id="monthSelector" onchange="changeMonth()"></select>
</div>

<div id="editingNotice" class="editing-mode" style="display: none;">
  <strong style="color: #4CAF50;">‚úèÔ∏è Modalit√† modifica attiva</strong>
  <button onclick="cancelEdit()" style="max-width: 150px; margin-top: 5px;">‚ùå Annulla modifica</button>
</div>

<label for="voucherValue">Valore buono pasto (‚Ç¨):</label>
<input type="number" id="voucherValue" value="7.00" step="0.01" min="0">

<label for="day">Data del turno:</label>
<input type="date" id="day">
<div class="info-text">Facoltativo</div>

<label for="start">Ora di inizio:</label>
<input type="time" id="start">
<div class="info-text">Facoltativo</div>

<label for="end">Ora di fine:</label>
<input type="time" id="end">
<div class="info-text">Facoltativo</div>

<label for="note">Note:</label>
<textarea id="note" placeholder="Esempi: ferie, riposo, permesso, malattia, turno speciale" rows="2"></textarea>
<div class="info-text">Facoltativo</div>

<div id="errorMsg" class="error"></div>
<div id="successMsg" class="success"></div>

<button onclick="save()" id="saveBtn">üíæ Salva turno</button>
<button onclick="exportPDF()">üìÑ Esporta PDF</button>
<button onclick="clearAll()">üóëÔ∏è Cancella tutto</button>

<ul id="list"></ul>

<div class="totali">
  <strong id="monthTitle" style="color: #FFD700;">Riepilogo Mese</strong>
  <div>Ore totali ordinarie: <span id="ordinaryTotal">0</span></div>
  <div>Ore totali straordinario: <span id="extraTotal">0</span></div>
  <div>Giorni presenti: <span id="daysPresent">0</span></div>
  <div>Totale buoni pasto (‚Ç¨): <span id="voucherTotal">0.00</span></div>
</div>

<script>
const DAILY_STANDARD = 7 + 15/60;
let currentMonth = null;
const EXEMPT_KEYWORDS = ['ferie', 'riposo', 'permesso', 'malattia'];
let editingIndex = null;

function getTodayString() {
  const today = new Date();
  return today.toISOString().split('T')[0];
}

function getYearMonth(dateStr) {
  return dateStr.substring(0, 7);
}

function getCurrentMonth() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  return `${year}-${month}`;
}

function initMonthSelector() {
  let data = JSON.parse(localStorage.getItem('orari') || '[]');
  const months = new Set();
  data.forEach(entry => {
    if (entry.d) months.add(getYearMonth(entry.d));
  });
  months.add(getCurrentMonth());
  const sortedMonths = Array.from(months).sort().reverse();
  const selector = document.getElementById('monthSelector');
  selector.innerHTML = '';
  sortedMonths.forEach(month => {
    const option = document.createElement('option');
    option.value = month;
    option.textContent = formatMonth(month);
    selector.appendChild(option);
  });
  if (sortedMonths.length > 0) {
    selector.value = sortedMonths[0];
    currentMonth = sortedMonths[0];
  }
}

function formatMonth(monthStr) {
  const [year, month] = monthStr.split('-');
  const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
  return `${months[parseInt(month) - 1]} ${year}`;
}

function changeMonth() {
  currentMonth = document.getElementById('monthSelector').value;
  cancelEdit();
  render();
}

function showError(msg) {
  const errorDiv = document.getElementById('errorMsg');
  errorDiv.textContent = msg;
  errorDiv.style.display = 'block';
  setTimeout(() => { errorDiv.style.display = 'none'; }, 4000);
}

function showSuccess(msg) {
  const successDiv = document.getElementById('successMsg');
  successDiv.textContent = msg;
  successDiv.style.display = 'block';
  setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
}

function isNoteExempt(note) {
  const lowerNote = note.toLowerCase().trim();
  return EXEMPT_KEYWORDS.some(keyword => lowerNote.includes(keyword));
}

function editEntry(index) {
  let data = JSON.parse(localStorage.getItem('orari') || '[]');
  const entry = data[index];
  
  document.getElementById('day').value = entry.d || '';
  document.getElementById('start').value = entry.s || '';
  document.getElementById('end').value = entry.e || '';
  document.getElementById('note').value = entry.note || '';
  
  editingIndex = index;
  document.getElementById('editingNotice').style.display = 'block';
  document.getElementById('saveBtn').textContent = '‚úèÔ∏è Aggiorna turno';
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelEdit() {
  editingIndex = null;
  document.getElementById('editingNotice').style.display = 'none';
  document.getElementById('saveBtn').textContent = 'üíæ Salva turno';
  document.getElementById('day').value = '';
  document.getElementById('start').value = '';
  document.getElementById('end').value = '';
  document.getElementById('note').value = '';
}

function save() {
  const d = document.getElementById('day').value;
  const s = document.getElementById('start').value;
  const e = document.getElementById('end').value;
  const n = document.getElementById('note').value.trim();
  
  if (!d && !s && !e && !n) { 
    showError('‚ùå Devi inserire almeno un campo');
    return; 
  }
  
  if (d) {
    const today = getTodayString();
    if (d > today) {
      showError('‚ùå Non puoi inserire una data nel futuro');
      return;
    }
  }
  
  if (s && e) {
    if (e <= s) {
      showError('‚ùå L\'ora di fine deve essere successiva all\'inizio');
      return;
    }
    const diff = getHours(s, e);
    if (diff > 24) {
      showError('‚ùå Le ore non possono superare 24');
      return;
    }
  } else if ((s && !e) || (e && !s)) {
    showError('‚ùå Inserisci sia inizio che fine oppure nessuno dei due');
    return;
  }
  
  let data = JSON.parse(localStorage.getItem('orari') || '[]');
  
  // Controllo duplicati solo se non stiamo modificando
  if (editingIndex === null) {
    const exists = data.some(x => x.d === d && x.s === s && x.e === e && x.note === n);
    if (exists) {
      showError('‚ö†Ô∏è Questo turno √® gi√† stato inserito');
      return;
    }
  }
  
  const diff = (s && e) ? getHours(s, e) : 0;
  
  try {
    if (editingIndex !== null) {
      // Modalit√† modifica
      data[editingIndex] = {d, s: s || '', e: e || '', ore: diff, note: n};
      showSuccess('‚úÖ Turno aggiornato con successo!');
      cancelEdit();
    } else {
      // Modalit√† inserimento
      data.push({d, s: s || '', e: e || '', ore: diff, note: n});
      showSuccess('‚úÖ Turno salvato con successo!');
    }
    localStorage.setItem('orari', JSON.stringify(data));
  } catch (e) {
    showError('‚ùå Impossibile salvare i dati. Spazio esaurito?');
    return;
  }
  
  if (d) {
    const newMonth = getYearMonth(d);
    if (!currentMonth || newMonth !== currentMonth) {
      initMonthSelector();
      document.getElementById('monthSelector').value = newMonth;
      currentMonth = newMonth;
    }
  }
  
  if (editingIndex === null) {
    document.getElementById('day').value = '';
    document.getElementById('start').value = '';
    document.getElementById('end').value = '';
    document.getElementById('note').value = '';
  }
  
  render();
}

function render() {
  let data = JSON.parse(localStorage.getItem('orari') || '[]');
  const monthlyData = data.filter(entry => entry.d && getYearMonth(entry.d) === currentMonth).sort((a, b) => (a.d || '').localeCompare(b.d || ''));
  
  const list = document.getElementById('list');
  if (monthlyData.length === 0) {
    list.innerHTML = '<li style="color: #999;">Nessun turno registrato</li>';
  } else {
    list.innerHTML = monthlyData.map((x, idx) => {
      const fullIdx = data.indexOf(x);
      let displayText = '';
      if (isNoteExempt(x.note)) {
        displayText = `<strong>${x.d ? formatDate(x.d) : 'Senza data'}:</strong> üìù ${x.note}`;
      } else if (x.s && x.e && x.ore > 0) {
        let extra = Math.max(0, x.ore - DAILY_STANDARD).toFixed(2);
        displayText = `<strong>${x.d ? formatDate(x.d) : 'Senza data'}:</strong> ${x.s} ‚Üí ${x.e} (${x.ore.toFixed(2)}h, extra: ${extra}h)${x.note ? ' üìù ' + x.note : ''}`;
      } else if (x.note) {
        displayText = `<strong>${x.d ? formatDate(x.d) : 'Senza data'}:</strong> üìù ${x.note}`;
      } else {
        displayText = `<strong>${x.d ? formatDate(x.d) : 'Senza data'}</strong>`;
      }
      return `<li>${displayText} <button class="edit-btn" onclick="editEntry(${fullIdx})">‚úèÔ∏è</button><button class="delete-btn" onclick="deleteEntry(${fullIdx})">üóëÔ∏è</button></li>`;
    }).join('');
  }
  
  document.getElementById('monthTitle').textContent = `Riepilogo ${formatMonth(currentMonth)}`;
  document.getElementById('ordinaryTotal').textContent = getMonthlyOrdinary(monthlyData).toFixed(2);
  document.getElementById('extraTotal').textContent = getMonthlyExtra(monthlyData).toFixed(2);
  document.getElementById('daysPresent').textContent = monthlyData.filter(x => x.d && x.s && x.e && x.ore > 0 && !isNoteExempt(x.note)).length;
  const voucherCount = monthlyData.filter(x => x.d && !isNoteExempt(x.note) && x.s && x.e && x.ore > 0).length;
  const voucherValue = parseFloat(document.getElementById('voucherValue').value) || 0;
  document.getElementById('voucherTotal').textContent = (voucherCount * voucherValue).toFixed(2);
}

function formatDate(dateStr) {
  const [year, month, day] = dateStr.split('-');
  return `${day}/${month}/${year}`;
}

function getHours(start, end) {
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  let diff = (eh + em / 60) - (sh + sm / 60);
  if (diff < 0) diff += 24;
  return Math.round(diff * 100) / 100;
}

function getMonthlyOrdinary(data) {
  let total = 0;
  data.forEach(x => {
    if (!isNoteExempt(x.note) && x.s && x.e && x.ore > 0) {
      total += Math.min(x.ore, DAILY_STANDARD);
    }
  });
  return Math.round(total * 100) / 100;
}

function getMonthlyExtra(data) {
  let total = 0;
  data.forEach(x => {
    if (!isNoteExempt(x.note) && x.s && x.e && x.ore > 0) {
      total += Math.max(0, x.ore - DAILY_STANDARD);
    }
  });
  return Math.round(total * 100) / 100;
}

function deleteEntry(index) {
  if (!confirm('Sei sicuro di voler eliminare questo turno?')) return;
  let data = JSON.parse(localStorage.getItem('orari') || '[]');
  data.splice(index, 1);
  try {
    localStorage.setItem('orari', JSON.stringify(data));
  } catch (e) {
    showError('‚ùå Impossibile salvare le modifiche');
    return;
  }
  initMonthSelector();
  cancelEdit();
  render();
}

function clearAll() {
  if (!confirm('Sei sicuro di voler eliminare TUTTI i turni?')) return;
  localStorage.removeItem('orari');
  initMonthSelector();
  cancelEdit();
  render();
}

function getDaysInMonth(yearMonth) {
  const [year, month] = yearMonth.split('-').map(Number);
  return new Date(year, month, 0).getDate();
}

function getAllDaysInMonth(yearMonth) {
  const daysInMonth = getDaysInMonth(yearMonth);
  const days = [];
  for (let day = 1; day <= daysInMonth; day++) {
    const dayStr = String(day).padStart(2, '0');
    days.push(`${yearMonth}-${dayStr}`);
  }
  return days;
}

function exportPDF() {
  let data = JSON.parse(localStorage.getItem('orari') || '[]');
  const allDays = getAllDaysInMonth(currentMonth);
  const voucherValue = parseFloat(document.getElementById('voucherValue').value) || 0;
  
  // Creo un map dei dati esistenti
  const dataMap = {};
  data.forEach(entry => {
    if (entry.d && getYearMonth(entry.d) === currentMonth) {
      dataMap[entry.d] = entry;
    }
  });
  
  // Creo array completo con tutti i giorni
  const completeMonthData = allDays.map(day => {
    return dataMap[day] || { d: day, s: '', e: '', ore: 0, note: '' };
  });
  
  let htmlContent = `
    <div style="font-family: Arial, sans-serif; color: #000; font-size: 7px; padding: 8px;">
      
      <!-- Intestazione compatta -->
      <div style="text-align: center; margin-bottom: 6px; border-bottom: 2px solid #001F3F; padding-bottom: 4px;">
        <h1 style="margin: 0; font-size: 14px; color: #001F3F;">üëÆ‚Äç‚ôÇÔ∏è ORARI VIGILANZA PRIVATA</h1>
        <div style="font-size: 9px; color: #666; margin-top: 2px;">Agente Matricola 2544</div>
        <div style="font-size: 10px; font-weight: bold; color: #001F3F; margin-top: 2px;">${formatMonth(currentMonth)}</div>
      </div>
      
      <!-- Tabella con tutti i giorni -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 6px; font-size: 7px;">
        <thead>
          <tr style="background-color: #001F3F; color: white;">
            <th style="border: 1px solid #001F3F; padding: 3px; text-align: left; width: 10%;">Giorno</th>
            <th style="border: 1px solid #001F3F; padding: 3px; text-align: center; width: 8%;">Inizio</th>
            <th style="border: 1px solid #001F3F; padding: 3px; text-align: center; width: 8%;">Fine</th>
            <th style="border: 1px solid #001F3F; padding: 3px; text-align: center; width: 7%;">Ore</th>
            <th style="border: 1px solid #001F3F; padding: 3px; text-align: center; width: 7%;">Extra</th>
            <th style="border: 1px solid #001F3F; padding: 3px; text-align: left; width: 50%;">Note</th>
            <th style="border: 1px solid #001F3F; padding: 3px; text-align: center; width: 10%;">Buono (‚Ç¨)</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  completeMonthData.forEach((x, idx) => {
    let inizio = x.s || '-';
    let fine = x.e || '-';
    let ore = (x.ore > 0) ? x.ore.toFixed(2) : '-';
    let extra = (x.ore > 0) ? Math.max(0, x.ore - DAILY_STANDARD).toFixed(2) : '-';
    let buono = (x.s && x.e && x.ore > 0 && !isNoteExempt(x.note)) ? voucherValue.toFixed(2) : '-';
    
    const bgColor = idx % 2 === 0 ? '#FFFFFF' : '#F9F9F9';
    
    htmlContent += `
      <tr style="background-color: ${bgColor};">
        <td style="border: 1px solid #ddd; padding: 3px; text-align: left;"><strong>${formatDate(x.d)}</strong></td>
        <td style="border: 1px solid #ddd; padding: 3px; text-align: center;">${inizio}</td>
        <td style="border: 1px solid #ddd; padding: 3px; text-align: center;">${fine}</td>
        <td style="border: 1px solid #ddd; padding: 3px; text-align: center;">${ore}</td>
        <td style="border: 1px solid #ddd; padding: 3px; text-align: center;">${extra}</td>
        <td style="border: 1px solid #ddd; padding: 3px; text-align: left; font-size: 6px;">${x.note || ''}</td>
        <td style="border: 1px solid #ddd; padding: 3px; text-align: center;"><strong>${buono}</strong></td>
      </tr>
    `;
  });
  
  const monthlyData = completeMonthData.filter(x => x.s && x.e && x.ore > 0);
  const totalOrdinary = getMonthlyOrdinary(monthlyData).toFixed(2);
  const totalExtra = getMonthlyExtra(monthlyData).toFixed(2);
  const totalDays = monthlyData.filter(x => x.d && x.s && x.e && x.ore > 0 && !isNoteExempt(x.note)).length;
  const totalVouchers = monthlyData.filter(x => x.d && !isNoteExempt(x.note) && x.s && x.e && x.ore > 0).length * voucherValue;
  
  htmlContent += `
        </tbody>
      </table>
      
      <!-- Riquadro riepilogo ottimizzato -->
      <div style="background-color: #F5F5F5; border: 2px solid #001F3F; padding: 6px; font-size: 8px; page-break-inside: avoid;">
        <div style="text-align: center; font-weight: bold; color: #001F3F; margin-bottom: 4px; font-size: 10px;">üìä RIEPILOGO ${formatMonth(currentMonth).toUpperCase()}</div>
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 2px 0;"><strong>Ore totali ordinarie:</strong></td>
            <td style="text-align: right; color: #001F3F; font-weight: bold; padding: 2px 0;">${totalOrdinary}h</td>
          </tr>
          <tr>
            <td style="padding: 2px 0;"><strong>Ore totali straordinario:</strong></td>
            <td style="text-align: right; color: #FF6B35; font-weight: bold; padding: 2px 0;">${totalExtra}h</td>
          </tr>
          <tr>
            <td style="padding: 2px 0;"><strong>Giorni presenti:</strong></td>
            <td style="text-align: right; color: #001F3F; font-weight: bold; padding: 2px 0;">${totalDays}</td>
          </tr>
          <tr>
            <td style="padding: 2px 0;"><strong>Totale buoni pasto:</strong></td>
            <td style="text-align: right; color: #28A745; font-weight: bold; padding: 2px 0;">‚Ç¨ ${totalVouchers.toFixed(2)}</td>
          </tr>
        </table>
      </div>
      
      <!-- Footer con autore -->
      <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 7px; color: #666; page-break-inside: avoid;">
        <div>Documento generato il ${new Date().toLocaleDateString('it-IT')}</div>
        <div style="text-align: right;">
          <div><strong>Autore: Aro1965</strong></div>
          <div style="font-size: 6px; color: #999;">ver.2.0</div>
        </div>
      </div>
    </div>
  `;
  
  const element = document.createElement('div');
  element.innerHTML = htmlContent;
  
  html2pdf().set({
    margin: [6, 6, 6, 6],
    filename: `Orari_Matricola2544_${currentMonth}.pdf`,
    image: { type: 'jpeg', quality: 0.95 },
    html2canvas: { scale: 2, letterRendering: true, useCORS: true },
    jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4', compressPDF: true }
  }).from(element).save();
  
  showSuccess('‚úÖ PDF esportato con successo!');
}

initMonthSelector();
if (!currentMonth) currentMonth = getCurrentMonth();
render();
</script>
</body>
</html>
